// Generated by CoffeeScript 1.6.3
(function() {
  var App, AppView, Task, TaskList, TaskView, Tasks, colour_map;

  _.templateSettings = {
    interpolate: /\{\{(.+?)\}\}/
  };

  colour_map = _.memoize(function(name) {
    var char, hash, mash, _i, _len;
    hash = 360;
    mash = function(char) {
      var n;
      n = char.charCodeAt(0);
      return hash = n + (hash << 6) + (hash << 16) - hash;
    };
    for (_i = 0, _len = name.length; _i < _len; _i++) {
      char = name[_i];
      mash(char);
    }
    return $.husl.p.toHex(hash % 360, 100, 58);
  });

  Task = Backbone.Model.extend({
    urlRoot: '/tasks/',
    url: function() {
      return this.id || this.urlRoot;
    },
    idAttribute: 'href',
    defaults: function() {
      return {
        date: new Date(),
        description: '',
        duration: 0,
        project: {
          name: ''
        }
      };
    },
    toJSON: function() {
      var full;
      full = _.clone(this.attributes);
      full.project = full.project.name;
      return full;
    }
  });

  TaskList = Backbone.Collection.extend({
    model: Task,
    url: '/tasks/',
    parse: function(data) {
      return data.tasks;
    },
    comparator: 'date'
  });

  Tasks = new TaskList;

  TaskView = Backbone.View.extend({
    tagName: 'li',
    template: _.template($('#task-template').html()),
    events: {
      'click .task-edit': 'edit',
      'click .task-remove': 'clear',
      'click .task-update': 'close'
    },
    initialize: function() {
      this.listenTo(this.model, 'change', this.render);
      return this.listenTo(this.model, 'destroy', this.remove);
    },
    render: function() {
      var nice_attributes, project_colour;
      nice_attributes = _.clone(this.model.attributes);
      nice_attributes.duration /= 60;
      this.$el.html(this.template(nice_attributes));
      project_colour = colour_map(nice_attributes.project.name);
      $('.task-project', this.el).css({
        color: project_colour
      });
      $(':hover');
      return this;
    },
    edit: function() {
      this.$el.addClass('editing');
      this.$('.task-thing').attr('contenteditable', 'true');
      return this.$('.task-description').focus();
    },
    close: function() {
      this.model.save({
        date: this.$('.task-date').text(),
        description: this.$('.task-description').text(),
        duration: this.$('.task-duration').text() * 60,
        project: {
          name: this.$('.task-project').text()
        }
      });
      this.$el.removeClass('editing');
      return this.$('.task-thing').attr('contenteditable', 'false');
    },
    clear: function() {
      return this.model.destroy();
    }
  });

  AppView = Backbone.View.extend({
    el: $('#trackerapp'),
    events: {
      'click #save-new-task': 'save_new'
    },
    initialize: function() {
      this.new_form = {
        duration: this.$("#new-duration"),
        description: this.$("#new-description"),
        date: this.$("#new-date"),
        project: this.$("#new-project")
      };
      this.listenTo(Tasks, 'add', this.add_one);
      this.listenTo(Tasks, 'reset', this.add_all);
      this.listenTo(Tasks, 'all', this.render);
      this.main = $("#main");
      return Tasks.fetch();
    },
    render: function() {
      if (Tasks.length) {
        return this.main.show();
      } else {
        return this.main.hide();
      }
    },
    add_one: function(task) {
      var view;
      view = new TaskView({
        model: task
      });
      return this.$("#task-list").append(view.render().el);
    },
    add_all: function() {
      return Tasks.each(this.add_one, this);
    },
    save_new: function() {
      Tasks.create({
        duration: this.new_form.duration.val() * 60,
        description: this.new_form.description.val(),
        date: this.new_form.date.val(),
        project: {
          name: this.new_form.project.val()
        }
      });
      return _(this.new_form).each(function(thing) {
        return thing.val('');
      });
    }
  });

  App = new AppView;

}).call(this);
